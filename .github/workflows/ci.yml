name: CI

on:
    push:
        branches: [main, master, develop]
    pull_request:
        branches: [main, master, develop]

jobs:
    lint:
        name: Lint
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup pnpm
              uses: pnpm/action-setup@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '20'
                  cache: 'pnpm'

            - name: Install dependencies
              run: pnpm install --frozen-lockfile

            - name: Run ESLint
              run: pnpm lint

            - name: Check Prettier formatting
              run: pnpm format:check

    test:
        name: Test (Node ${{ matrix.node-version }})
        runs-on: ubuntu-latest
        needs: lint
        strategy:
            matrix:
                node-version: ['18', '20']

        services:
            mongodb:
                image: mongo:latest
                ports:
                    - 27017:27017
                options: >-
                    --health-cmd "mongosh --eval 'db.adminCommand(\"ping\")'"
                    --health-interval 10s
                    --health-timeout 5s
                    --health-retries 5

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup pnpm
              uses: pnpm/action-setup@v4

            - name: Setup Node.js ${{ matrix.node-version }}
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ matrix.node-version }}
                  cache: 'pnpm'

            - name: Install dependencies
              run: pnpm install --frozen-lockfile

            - name: Run tests with coverage
              run: pnpm test:cov
              env:
                  NODE_ENV: test
                  MONGO_URI: mongodb://localhost:27017/ddd-blog-test
                  JWT_SECRET: test-jwt-secret
                  JWT_EXPIRES_IN: 1d
                  REFRESH_TOKEN_SECRET: test-refresh-secret
                  REFRESH_TOKEN_EXPIRES_IN: 7d

            - name: Upload coverage report
              uses: codecov/codecov-action@v4
              if: matrix.node-version == '20'
              with:
                  fail_ci_if_error: false
                  files: ./coverage/lcov.info
                  flags: unittests
                  name: codecov-umbrella

    build:
        name: Build Docker Image
        runs-on: ubuntu-latest
        needs: test
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Build Docker image
              uses: docker/build-push-action@v5
              with:
                  context: .
                  push: false
                  tags: ddd-blog-app:latest
                  cache-from: type=gha
                  cache-to: type=gha,mode=max
